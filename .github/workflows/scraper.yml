name: Run Scraper

on:
  workflow_dispatch: # Disparo manual
  schedule:
    - cron: "0 9 * * *" # Executa diariamente às 09h UTC

jobs:
  run-scraper:
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout do código
        uses: actions/checkout@v3

      - name: 🐍 Configura Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: 📦 Instala dependências
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: 🔑 Exporta Secrets
        run: |
          echo "Exportando secrets como variáveis de ambiente..."
          echo "GOOGLE_DRIVE_FOLDER_ID=${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}" >> $GITHUB_ENV
          echo "TERMS_FILE_ID=${{ secrets.TERMS_FILE_ID }}" >> $GITHUB_ENV
          echo "SERVICE_ACCOUNT_JSON=${{ secrets.SERVICE_ACCOUNT_JSON }}" >> $GITHUB_ENV
          echo "TARGET_REPO=${{ secrets.TARGET_REPO }}" >> $GITHUB_ENV
          echo "TARGET_BRANCH=${{ secrets.TARGET_BRANCH }}" >> $GITHUB_ENV

      - name: ⚙️ Decodifica credenciais e executa o script
        run: |
          echo "$SERVICE_ACCOUNT_JSON" | base64 --decode > "$SERVICE_ACCOUNT_FILE"
          python main.py
        env:
          GOOGLE_DRIVE_FOLDER_ID: ${{ env.GOOGLE_DRIVE_FOLDER_ID }}
          TERMS_FILE_ID: ${{ env.TERMS_FILE_ID }}
          SERVICE_ACCOUNT_JSON: ${{ env.SERVICE_ACCOUNT_JSON }}
          SERVICE_ACCOUNT_FILE: servicescraperdou.json
          GITHUB_TOKEN: ${{ secrets.PAT_GITHUB }}  # <-- Personal Access Token aqui
          TARGET_REPO: ${{ env.TARGET_REPO }}
          TARGET_BRANCH: ${{ env.TARGET_BRANCH }}
